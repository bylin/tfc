# Model LUAD stage
_Last modified `r format(Sys.time(), "%I:%M %p on %b %d, %Y")`. This document, R session image, version history, knitr cache, figures, and other associated datasets are located in `/inside/grotto/blin/trna-markers/luad/predict/`._

```{r setup, echo=FALSE, warning=FALSE, results=FALSE, message=FALSE, errors=FALSE, cache=FALSE}
library(knitr)
opts_chunk$set(cache = TRUE, cache.path = "/inside/grotto/blin/trna-markers/luad/predict/cache/predict/", eval = TRUE, echo = TRUE, warning = FALSE, results = FALSE, message = FALSE, autodep = TRUE, dev = "png", dpi = 300)
```

```{r libraries, cache=FALSE}
library(plyr)
library(glmnet)
library(ROCR)
library(GenomicRanges)
library(stringr)
library(reshape2)
library(survival)
set.seed(12)
source('/inside/home/blin/lib/R/ggsurv.R')
load('/inside/home/blin/grotto/data/hg19-srnas.RData')
load('/inside/home/blin/grotto/trna-markers/process-reads/luad-counts.RData')
luad_clinical <- luad_clinical[match(colnames(luad_adjusted_counts), luad_clinical$barcode), ]
ntrials <- 200
```

## Predict clinical covariates given counts

### Generic function for classification of samples into discrete classes

```{r utility-functions}
source('predict.R') 
```

```{r build-test-compare-glms}
buildTestCompareGlms <- function(metadata, covariate, counts, ntrials) {
  # metadata: filtered metadata for covariate of interest
  # counts: filtered counts containing only sample with covariate of interest

  # set up feature sets
  load('/inside/home/blin/grotto/data/hg19-srnas.RData')
  tsrnas <- unique(srnas[srnas$class %in% c("fivehalf", "threehalf", "trailer")]$tx_name)
  mirnas <- unique(srnas[str_detect(srnas$class, "mi")]$tx_name)
  snornas <- unique(srnas[srnas$class == "snoRNA"]$tx_name)
  pirnas <- unique(srnas[srnas$class == "piRNA"]$tx_name)

  # create training/testing sets and feature sets
  system(paste0('echo Setting up training/testing sets'))
  datasets <- lapply(1:ntrials, function(i) setupTrainingTestingSets(metadata, covariate, counts))


  # build, test on scrambled data (control)
  system(paste0('echo Building/testing models - control'))
  control_tsrna_glms <- lapply(datasets, buildTestGlm, features = tsrnas, covariate = covariate, randomize = TRUE) # the same models are built twice, but the code is a lot cleaner this way
  control_mirna_glms <- lapply(datasets, buildTestGlm, features = mirnas, covariate = covariate, randomize = TRUE)
  control_feature_glms <- list(control_tsrna_glms, control_mirna_glms)
  control_roc <- ldply(mapply(parseGlms, glms = control_feature_glms, class = c("tsRNA, permuted", "miRNA, permuted"), SIMPLIFY = FALSE), identity)
  
  # build and predict testing data
  system(paste0('echo Building/testing models'))
  all_feature_glms <- lapply(list(tsrnas, mirnas, snornas, pirnas), function(features) {
  	lapply(datasets, buildTestGlm, features = features, covariate = covariate, randomize = FALSE)
  	})
  roc <- ldply(mapply(parseGlms, glms = all_feature_glms, class = c("tsRNA", "miRNA", "snoRNA", "piRNA"), SIMPLIFY = FALSE), identity)
  roc <- rbind(roc, control_roc)
  roc$Class <- factor(roc$Class, levels = c("tsRNA", "miRNA", "tsRNA, permuted", "snoRNA", "piRNA", "miRNA, permuted"))

  # create plots
  system(paste0('echo Creating summary plot'))
  plot <- plotGlms(roc)

  # create summary object
  summary <- list()
  summary$glms <- all_feature_glms
  summary$control_glms <- control_feature_glms
  summary$roc <- roc
  summary$plot <- plot
  summary$samples <- lapply(datasets, function(dataset) unname(dataset$participant_ids))
  summary
}

```

### Cancer incidence

```{r sample-type}
metadata <- luad_clinical
metadata$sample_type <- as.factor(metadata$sample_type)
sample_type <- buildTestCompareGlms(metadata = metadata, covariate = "sample_type", counts = luad_adjusted_counts, ntrials = ntrials)
```

```{r sample-type-plot, fig.width=15, fig.height=8}
sample_type$plot
```

```{r sample-type-auc-plot, fig.width=8, fig.height=6}
plotAucs(sample_type$glms)
```

### Metastasis

```{r metastasis}
metadata <- luad_clinical[luad_clinical$m_stage %in% c("M0", "M1", "M1a", "M1b") & luad_clinical$sample_type == "TP", ]
counts <- luad_adjusted_counts[, colnames(luad_adjusted_counts) %in% metadata$barcode]
metadata$metastasis <- as.factor(ifelse(metadata$m_stage == "M0", "No metastasis" , "Metastasis"))
metastasis <- buildTestCompareGlms(metadata = metadata, covariate = "metastasis", counts = counts, ntrials = ntrials)
```

```{r metastasis-plot, fig.width=15, fig.height=8}
metastasis$plot
```

```{r metastasis-auc-plot, fig.width=8, fig.height=6}
plotAucs(metastasis$glms)
```

### Cancer stage

```{r stage-coarse}
# stage I, IA vs stage IIIA, IIIB, IV - essentially spreading vs non-spreading
metadata <- luad_clinical[luad_clinical$stage %in% c("Stage I", "Stage IA", "Stage IIIA", "Stage IIIB", "Stage IV") & luad_clinical$sample_type == "TP", ]
counts <- luad_adjusted_counts[, colnames(luad_adjusted_counts) %in% metadata$barcode]
metadata$stage <- as.factor(ifelse(metadata$stage %in% c("Stage I", "Stage IA"), "Early stage" , "Late stage"))
stage_coarse <- buildTestCompareGlms(metadata = metadata, covariate = "stage", counts = counts, ntrials = ntrials)
```

```{r stage-coarse-plot, fig.width=15, fig.height=8}
stage_coarse$plot
```

```{r stage-coarse-auc-plot, fig.width=8, fig.height=6}
plotAucs(stage_coarse$glms)
```

### Lymph node spread

```{r lymph}
metadata <- luad_clinical[luad_clinical$n_stage %in% c("N0", "N1", "N2", "N3") & luad_clinical$sample_type == "TP", ]
counts <- luad_adjusted_counts[, colnames(luad_adjusted_counts) %in% metadata$barcode]
metadata$n_stage <- as.factor(ifelse(metadata$n_stage %in% c("N0"), "N0" , "N1+"))
lymph_spread <- buildTestCompareGlms(metadata = metadata, covariate = "n_stage", counts = counts, ntrials = ntrials)
```

```{r lymph-plot, fig.width=15, fig.height=8}
lymph_spread$plot
```

```{r lmyph-auc-plot, fig.width=8, fig.height=6}
plotAucs(lymph_spread$glms)
```

```{r extract-coefs, fig.width=8, fig.height=6}
tsrna_coefs <- c(extractCoefs(sample_type$glms[[1]], ntrials), extractCoefs(stage_coarse$glms[[1]], ntrials))
tsrna_coefs <- data.frame(table(names(tsrna_coefs)), stringsAsFactors = FALSE)
colnames(tsrna_coefs) <- c("Name", "Frequency")
tsrna_coefs <- tsrna_coefs[order(tsrna_coefs$Frequency, decreasing = TRUE), ]
ggplot(tsrna_coefs) + geom_histogram(aes(x = Frequency)) + xlab(paste("No. times tsRNA selected in", ntrials, "GLMs"))

mirna_coefs <- c(extractCoefs(sample_type$glms[[2]], ntrials), extractCoefs(stage_coarse$glms[[2]], ntrials))
mirna_coefs <- data.frame(table(names(mirna_coefs)), stringsAsFactors = FALSE)
colnames(mirna_coefs) <- c("Name", "Frequency")
mirna_coefs <- mirna_coefs[order(mirna_coefs$Frequency, decreasing = TRUE), ]
ggplot(mirna_coefs) + geom_histogram(aes(x = Frequency)) + xlab(paste("No. times miRNA selected in", ntrials, "GLMs"))

save(tsrna_coefs, mirna_coefs, file = "coefs.RData")
```

## Feature selection and predicting survival time

### Build model, get coefficients

```{r glmnet-cox-1}
metadata <- luad_clinical[luad_clinical$sample_type == "TP" & luad_clinical$days_survived > 0 & luad_clinical$days_survived < 3000 & !is.na(luad_clinical$days_survived), ]
counts <- luad_adjusted_counts[rownames(luad_adjusted_counts) %in% tsrna_coefs[tsrna_coefs$Frequency > 10, ]$Name, colnames(luad_adjusted_counts) %in% metadata$barcode]
metadata$dummy <- as.factor(1)
dataset <- setupTrainingTestingSets(metadata, "dummy", counts)
training_counts <- t(dataset$training_counts)
training_response <- Surv(dataset$training_metadata$days_survived, dataset$training_metadata$vital_status)
model <- cv.glmnet(training_counts, training_response, family = "cox")
plot(model)
coef(model, s = model$lambda.min)
plot(model$glmnet.fit, label = TRUE)
```

### Naive Cox model prediction using summed hazard ratios

```{r glmnet-cox-2}
testing_counts <- t(dataset$testing_counts)
testing_response <- as.factor(ifelse(dataset$testing_metadata$days_survived >= 1095, ">3", "<3")) # test 1 year survival rate
pred <- predict(model, newx = testing_counts, s = model$lambda.min) 
prob <- prediction(-pred, testing_response) # flip signs because a positive hazard ratio gives a higher risk of death
perf <- performance(prob, "tpr", "fpr")
roc <- data.frame(TPR = unlist(perf@y.values), FPR = unlist(perf@x.values))
auc <- unlist(performance(prob, "auc")@y.values)
auc <- round(auc, 3)
ggplot(roc) + geom_line(aes(x = FPR, y = TPR)) + geom_abline(intercept = 0, slope = 1, colour = "gray") + ylab("TPR") + xlab("FPR")
auc
```

### Classify into high/low risk groups

```{r glmnet-cox-3}
metadata <- dataset$testing_metadata
metadata$risk <- as.factor(ifelse(pred > median(pred), "High-risk", "Low-risk"))
km <- survfit(Surv(days_survived, vital_status) ~ risk, data = metadata)
ggsurv(km) + theme_bw() + ggtitle("Kaplan-Meier plot")
cox <- coxph(Surv(days_survived, vital_status) ~ risk, data = metadata)
summary(cox)
```

### Build new logistic regression model using hazard ratios


```{r glmnet-cox-4}


```

```{r save-session, cache=FALSE}
save.session("predict.RSession")
```
